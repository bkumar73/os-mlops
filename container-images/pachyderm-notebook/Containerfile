FROM FROM quay.io/thoth-station/s2i-minimal-py38-notebook:v0.5.1

ENV PACHCTL_VERSION 2.1.6
ENV JUPYTERLAB_PACHYDERM_VERSION 2.4.2

USER root
RUN mkdir -p /pfs \
 && chmod 1777 /pfs

RUN dnf -y update \
 && dnf -y install curl fuse \
 && dnf -y clean all \
 && rm -rf /var/cache/dnf

RUN echo "user_allow_other" | sudo tee -a /etc/fuse.conf > /dev/null
#COPY ./dist-pach/pachctl/pachctl_linux_amd64/pachctl /usr/local/bin/pachctl
#COPY ./dist-pach/mount-server/mount-server_linux_amd64/mount-server/ /usr/local/bin/mount-server
RUN curl -f -o pachctl.tar.gz -L https://storage.googleapis.com/pachyderm-builds/pachctl_${PACHCTL_VERSION}_linux_amd64.tar.gz
RUN tar zxfv pachctl.tar.gz && mv pachctl_${PACHCTL_VERSION}_linux_amd64/pachctl /usr/local/bin/
RUN curl -f -o mount-server.tar.gz -L https://storage.googleapis.com/pachyderm-builds/mount-server_${PACHCTL_VERSION}_linux_amd64.tar.gz
RUN tar zxfv mount-server.tar.gz && mv mount-server_${PACHCTL_VERSION}_linux_amd64/mount-server /usr/local/bin/

USER 8888
RUN pip install --upgrade pip

USER root
WORKDIR /app
COPY /scripts/config.sh .
RUN chmod +x config.sh

USER 8888
COPY dist dist
WORKDIR /home/jovyan
RUN pip install `find /app/dist/ -name \*.whl` nbgitpuller

RUN pip install --no-cache-dir jupyterlab-pachyderm==${JUPYTERLAB_PACHYDERM_VERSION}

USER 8888
